---
title: "Correlations"
author: "Puvvula"
date: "10/11/2021"
output: pdf_document
---

```{r}
library(tidyverse)
library(skimr)
library(janitor)
library(corrplot)

dat<- read_csv("/work/jessebell/puvvula/aqd_final_data/pAsthma_imputed.csv")

#Focus until col 59

```

```{r}
#data formatting

dat$date <- as.Date(dat$date, format = "%m/%d/%Y")

#cat_var <- c(3:7,19:28,30)
#dat[,cat_var]<- lapply(dat[,cat_var], factor)

skim(dat)
```

```{r}
#Data normalization and trend plot
normalize <- function(x, na.rm = TRUE) {return((x- min(x)) /(max(x)-min(x)))}
dat_norm<- as.data.frame(lapply(dat[2:59], normalize))

write.csv(dat_norm, "/work/jessebell/puvvula/aqd_final_data/norm.csv")
#Added date col manually

#Min-Max scaled data with date
norm_dat<- read_csv("/work/jessebell/puvvula/aqd_final_data/norm.csv")
norm_plt<- norm_dat %>% gather(metric, value, p_ast:mld_17)

library(lubridate)

norm_plt$date <- as.Date(norm_plt$date, format = "%m/%d/%Y")
df <- norm_plt %>% mutate(year = year(date),
                          month = month(date, label=TRUE),
                          day = day(date))


ggplot(df,aes(day,metric$p_ast,fill=value))+
  geom_tile(color= "white",size=0.1)+ 
  facet_grid(year~month)+
  scale_fill_gradient(low="red", high="green")+
  theme(axis.line = element_line(colour = "black"))+
  theme_bw()

write_csv(df, "/work/jessebell/puvvula/aqd_final_data/norm_f_tableau.csv")
```



```{r}

M<-cor(dat[2:59])

cor.mtest <- function(mat, ...) {
  mat <- as.matrix(mat)
  n <- ncol(mat)
  p.mat<- matrix(NA, n, n)
  diag(p.mat) <- 0
  for (i in 1:(n - 1)) {
    for (j in (i + 1):n) {
      tmp <- cor.test(mat[, i], mat[, j], ...)
      p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
    }
  }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(dat[2:59])

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
cor_plt<-corrplot(M, method="color", col=col(200),  
         type="upper", order="original",
         tl.col="black", tl.srt=90, cl.cex = 1, tl.cex = 0.7, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE)

```



